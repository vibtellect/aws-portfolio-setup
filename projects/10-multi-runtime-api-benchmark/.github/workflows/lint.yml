name: Lint

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'projects/10-multi-runtime-api-benchmark/**'
      - '.github/workflows/lint.yml'
  push:
    branches: [main, develop]
    paths:
      - 'projects/10-multi-runtime-api-benchmark/**'
      - '.github/workflows/lint.yml'

defaults:
  run:
    working-directory: projects/10-multi-runtime-api-benchmark

jobs:
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: |
          pip install black flake8 pylint mypy
          cd lambdas/python
          pip install -r requirements.txt

      - name: Black format check
        run: |
          cd lambdas/python
          black --check src/ tests/

      - name: Flake8
        run: |
          cd lambdas/python
          flake8 src/ tests/ --max-line-length=100 --extend-ignore=E203,W503

      - name: Pylint
        run: |
          cd lambdas/python
          pylint src/ --disable=C0111,R0903 --max-line-length=100 || true

  lint-typescript:
    name: Lint TypeScript
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'projects/10-multi-runtime-api-benchmark/lambdas/typescript/package-lock.json'

      - name: Install dependencies
        run: |
          cd lambdas/typescript
          npm ci

      - name: ESLint
        run: |
          cd lambdas/typescript
          npx eslint src/ --ext .ts || true

      - name: Prettier check
        run: |
          cd lambdas/typescript
          npx prettier --check "src/**/*.ts" || true

      - name: TypeScript compile check
        run: |
          cd lambdas/typescript
          npx tsc --noEmit

  lint-go:
    name: Lint Go
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: projects/10-multi-runtime-api-benchmark/lambdas/go
          args: --timeout=5m

      - name: go fmt
        run: |
          cd lambdas/go
          test -z $(gofmt -l .)

      - name: go vet
        run: |
          cd lambdas/go
          go vet ./...

  lint-kotlin:
    name: Lint Kotlin
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission
        run: |
          cd lambdas/kotlin
          chmod +x gradlew

      - name: ktlint check
        run: |
          cd lambdas/kotlin
          ./gradlew ktlintCheck || true

      - name: detekt check
        run: |
          cd lambdas/kotlin
          ./gradlew detekt || true

  lint-cdk:
    name: Lint CDK
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'projects/10-multi-runtime-api-benchmark/cdk/package-lock.json'

      - name: Install dependencies
        run: |
          cd cdk
          npm ci

      - name: ESLint
        run: |
          cd cdk
          npx eslint lib/ bin/ test/ --ext .ts || true

      - name: Prettier check
        run: |
          cd cdk
          npx prettier --check "**/*.ts" || true

      - name: TypeScript compile
        run: |
          cd cdk
          npx tsc --noEmit

  lint-scripts:
    name: Lint Scripts
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './projects/10-multi-runtime-api-benchmark/scripts'
          ignore_paths: './projects/10-multi-runtime-api-benchmark/scripts/*.py'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python linters
        run: pip install flake8 black

      - name: Lint Python scripts
        run: |
          cd scripts
          black --check *.py
          flake8 *.py --max-line-length=100 --extend-ignore=E203,W503

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-python, lint-typescript, lint-go, lint-kotlin, lint-cdk, lint-scripts]
    if: always()

    steps:
      - name: Check lint results
        run: |
          echo "## Lint Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint-python.result }}" == "success" ]; then
            echo "✅ Python: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Python: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-typescript.result }}" == "success" ]; then
            echo "✅ TypeScript: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ TypeScript: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-go.result }}" == "success" ]; then
            echo "✅ Go: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Go: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-kotlin.result }}" == "success" ]; then
            echo "✅ Kotlin: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Kotlin: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-cdk.result }}" == "success" ]; then
            echo "✅ CDK: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ CDK: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint-scripts.result }}" == "success" ]; then
            echo "✅ Scripts: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Scripts: Issues found" >> $GITHUB_STEP_SUMMARY
          fi
